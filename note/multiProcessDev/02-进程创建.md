## table of contents
- [虚拟地址空间](#虚拟地址空间)
- [进程创建](#进程创建)
- [GDB多进程调试](#gdb多进程调试)

## [虚拟地址空间](#table-of-contents)
```text
虚拟地址空间是一个进程可用的虚拟内存的集合。每个进程都有自己的虚拟地址空间，这个空间是由连续的虚拟地址组成的。虚拟地址空间的大小取决于底层硬件和操作系统的设计。
```

> 父子进程的虚拟地址空间
```text
一般来说，父子进程的虚拟地址空间是相同的，但是父子进程的物理地址空间是不同的。


但实际上，父子进程遵循的是读时共享写时复制的原则：
写时拷贝（Copy-on-Write，CoW）是 Linux 内核中的一种机制，它可以在进程之间共享内存时避免拷贝整个内存页的成本。这个机制可以让多个进程共享同一块内存，并且在其中一个进程修改内存时才实际地拷贝内存页。
读时共享是指在父子进程之间，在刚刚创建子进程后（在fork后），父子进程之间的全局变量、.data、.bbs、.text、栈、堆、环境变量、用户ID、宿主目录（进程用户家目录）、进程工作目录、信号处理方式等等，即0~3G的用户空间是完全一样的。

父子进程间遵循读时共享写时复制的原则，以此来减少复制时的开销。具体来讲只有进程空间的各段的内容要发生变化时（子进程或父进程进行写操作时，都会引起复制），才会将父进程的内容复制一份给子进程。在fork之后两个进程用的是相同的物理空间（内存区），子进程的代码段、数据段、堆栈都是指向父进程的物理空间，也就是说，两者的虚拟空间独立，但其对应的物理空间是同一个。即父子进程在逻辑上仍然是严格相互独立的两个进程，各自维护各自的参数，只是在物理上实现了读时共享，写时复制。
```

## [进程创建](#table-of-contents)
```text
进程的创建是通过fork系统调用来完成的，fork系统调用会创建一个与父进程几乎完全相同的子进程，这两个进程共享代码段、数据段、堆和共享库，但是子进程拥有自己的栈和寄存器，以及其他与进程相关的属性。
```
```c
/*
    #include <sys/types.h>
    #include <unistd.h>

    pid_t fork(void);
        函数的作用：用于创建子进程。
        返回值：
            fork()的返回值会返回两次。一次是在父进程中，一次是在子进程中。
            在父进程中返回创建的子进程的ID,
            在子进程中返回0
            如何区分父进程和子进程：通过fork的返回值。
            在父进程中返回-1，表示创建子进程失败，并且设置errno

        父子进程之间的关系：
        区别：
            1.fork()函数的返回值不同
                父进程中: >0 返回的子进程的ID
                子进程中: =0
            2.pcb中的一些数据
                当前的进程的id pid
                当前的进程的父进程的id ppid
                信号集

        共同点：
            某些状态下：子进程刚被创建出来，还没有执行任何的写数据的操作
                - 用户区的数据
                - 文件描述符表
        
        父子进程对变量是不是共享的？
            - 刚开始的时候，是一样的，共享的。如果修改了数据，不共享了。
            - 读时共享（子进程被创建，两个进程没有做任何的写的操作），写时拷贝。
        
*/
```

## [GDB多进程调试](#table-of-contents)
```text
使用 GDB 调试的时候，GDB 默认只能跟踪一个进程，可以在 fork 函数调用之前，通过指令设置 GDB 调试工具跟踪父进程或者是跟踪子进程，默认跟踪父进程。
```
```shell
# 跟踪子进程
set follow-fork-mode child
# 跟踪父进程
set follow-fork-mode parent

# 设置调试模式，默认为 on ，表示在调试当前进程的时候，其它进程继续运行，如果设置为 off ，则在调试当前进程的时候，其它进程会被挂起。
set detach-on-fork off

# 查看调试进度
info inferiors

# 切换调试进程
inferior id

# 使进程脱离 GDB 调试
detach inferior id
```
> 使用命令 `help` 查看完整的 GDB 命令列表